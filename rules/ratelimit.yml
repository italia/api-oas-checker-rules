rules:
  missing-retry-after:
    description: |-
      When a client is warned about a temporary server issue with a 503 status code,
      the server should explicitly communicate how long to wait
      before issuing further requests using the Retry-After header.

      Retry-After is defined in RFC7231.
    message: "[RFC7231] A 503 response must include the `Retry-After` header."
    formats:
      - oas3
    severity: warn
    recommended: true
    given: >-
      $..[responses][?(@property == "503" )][headers]
    then:
      field: Retry-After
      function: truthy
  missing-ratelimit:
    description: |-
      Ratelimiting an API preserves a service and limits attack scenario
      [see API4:2019 Lack of Resources & Rate Limiting](https://owasp.org/www-project-api-security).

      APIs should use the following headers on successful and client error responses:
      - `X-RateLimit-Limit`: number of total requests in a give time window
      - `X-RateLimit-Remaining`: remaining requests in the current window
      - `X-RateLimit-Reset`: number of seconds before the window resets

      An example set of headers is the following

      ```
      X-Ratelimit-Limit: 100
      X-Ratelimit-Remaining: 40
      X-Ratelimit-Reset: 12
      ```

      A standardization proposal for ratelimit headers is ongoing
      inside the IETF HTTPAPI Workgroup.
      See [the draft](https://datatracker.ietf.org/doc/draft-ietf-httpapi-ratelimit-headers/)
    message: "Missing or ambiguous rate-limit header: '{{property}}' must be defined (standard or X- prefix)."
    formats:
      - oas3
    severity: warn
    recommended: true
    given: >-
      $..[responses][?(@property[0] == "2" || @property[0] == "4")][headers]
    then:
    - functionOptions:
        properties:
        -  X-RateLimit-Limit
        -  RateLimit-Limit
      function: xor
    - functionOptions:
        properties:
          - X-RateLimit-Remaining
          - RateLimit-Remaining
      function: xor
    - functionOptions:
        properties:
          - X-RateLimit-Reset
          - RateLimit-Reset
      function: xor
